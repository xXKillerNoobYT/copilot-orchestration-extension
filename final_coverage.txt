
> copilot-orchestration-extension@0.0.1 test:once
> jest orchestrator.test.ts --coverage

PASS tests/orchestrator.test.ts
  Orchestrator Service
    initialization
      ΓêÜ Test 1: should initialize with default timeout when config missing (4 ms)
      ΓêÜ Test 2: should read timeout from config.orchestrator.taskTimeoutSeconds (2 ms)
      ΓêÜ Test 3: should fallback to llm.timeoutSeconds if orchestrator config missing
    manual mode ticket handling
      ΓêÜ Test 4: should set ai_to_human ticket to pending when manual mode enabled (2 ms)
      ΓêÜ Test 5: should skip pending update when auto mode enabled (19 ms)
    queue ordering (FIFO)
      ΓêÜ Test 6: should return tasks in FIFO order (1 ms)
      ΓêÜ Test 7: should return null when queue is empty
      ΓêÜ Test 8: should filter for open and in-progress tickets only
    timeout detection and blocking
      ΓêÜ Test 9: should create blocked ticket when task idle >30s (using fake timers) (4 ms)
      ΓêÜ Test 10: should not create duplicate blocked tickets for same task (2 ms)
    edge cases
      ΓêÜ Test 11: should handle TicketDb errors gracefully (1 ms)
      ΓêÜ Test 12: should throw error if getNextTask called before initialization (51 ms)
      ΓêÜ Test 13: should prevent duplicate initialization (1 ms)
    routeQuestionToAnswer
      ΓêÜ should call LLM with question and return response (1 ms)
      ΓêÜ should include Answer agent system prompt (1 ms)
      ΓêÜ should handle LLM failure and return fallback message (1 ms)
      ΓêÜ should not create duplicate ticket on LLM failure
      ΓêÜ should log question routing and response
    routeToPlanningAgent
      ΓêÜ should log chunks and accumulate full plan (2 ms)
      ΓêÜ should handle empty response gracefully (1 ms)
      ΓêÜ should truncate long plans in logs
    routeToVerificationAgent
      ΓêÜ should call completeLLM with verification system prompt (1 ms)
      ΓêÜ should parse PASS response and avoid ticket creation (1 ms)
      ΓêÜ should parse FAIL response and create blocked ticket (1 ms)
      ΓêÜ should default to FAIL on ambiguous response (1 ms)
      ΓêÜ should truncate long explanations in logs
      ΓêÜ should fail fast when code diff is empty
      ΓêÜ should handle LLM errors without creating duplicate tickets (1 ms)
    Planning Agent
      ΓêÜ should stream plan chunks to logs via callback (1 ms)
      ΓêÜ should handle empty plan response
      ΓêÜ should handle planning timeout by returning fallback message (1 ms)
    Answer Agent
      ΓêÜ should call completeLLM and log response (1 ms)
      ΓêÜ should create ticket when response contains "ticket" keyword
      ΓêÜ should create ticket when response contains "create" keyword
      ΓêÜ should not create ticket for normal response without action keywords (1 ms)
      ΓêÜ should warn and return early for empty question
      ΓêÜ should warn and return early for whitespace-only question (1 ms)
      ΓêÜ should truncate long response in logs (>500 chars)
      ΓêÜ should handle case-insensitive keyword detection (1 ms)
      ΓêÜ should handle completeLLM timeout error gracefully
      ΓêÜ should handle empty LLM response (1 ms)
      ΓêÜ should create ticket with truncated question in title (1 ms)

-------------------------------|---------|----------|---------|---------|----------------------------------------------------------------------------------------------------------------
File                           | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                              
-------------------------------|---------|----------|---------|---------|----------------------------------------------------------------------------------------------------------------
All files                      |   18.57 |    10.87 |   14.34 |   18.63 |                                                                                                                
 src                           |    3.33 |     0.61 |    2.22 |    3.33 |                                                                                                                
  extension.ts                 |    3.55 |     0.68 |    2.56 |    3.55 | 31-146,156-1146,1154-1185                                                                                      
  logger.ts                    |       0 |        0 |       0 |       0 | 22-84                                                                                                          
 src/agents                    |   14.96 |        0 |       0 |   15.17 |                                                                                                                
  answerAgent.ts               |    15.2 |        0 |       0 |   15.32 | 36-38,49-282,300-314,330-331,342-344,354-355,365-366,374-375,383-384,392                                       
  researchAgent.ts             |   13.63 |        0 |       0 |   14.28 | 9-93                                                                                                           
 src/mcpServer                 |    8.33 |        0 |       0 |    8.33 |                                                                                                                
  mcpServer.ts                 |    8.33 |        0 |       0 |    8.33 | 42-264,278-284,291-293,301                                                                                     
 src/services                  |   36.41 |    22.02 |   29.21 |   36.54 |                                                                                                                
  llmService.ts                |    5.16 |        0 |    6.66 |    5.23 | 64-74,95-186,200-245,266-353,374-584                                                                           
  orchestrator.ts              |   70.24 |     51.7 |   60.97 |   70.27 | 131,140-147,219-225,238-361,381-382,402,408,414-415,458-460,621,828-885,939,951-954,968,980-983,1009-1012,1017 
  ticketDb.ts                  |    7.84 |        0 |       0 |    7.94 | 45-346,356-362,367-370,375-378,383-386,391-394,399-402,406-409                                                 
 src/ui                        |   11.95 |     5.32 |   10.44 |   12.14 |                                                                                                                
  agentStatusTracker.ts        |   58.06 |       50 |    37.5 |   58.06 | 80-123                                                                                                         
  agentsTreeProvider.ts        |    6.25 |        0 |       0 |    6.25 | 18-211                                                                                                         
  conversationWebview.ts       |    6.32 |        0 |       0 |    6.57 | 26-564                                                                                                         
  conversationsTreeProvider.ts |    2.94 |        0 |       0 |    2.96 | 32-357                                                                                                         
  llmStatusBar.ts              |   68.75 |    66.66 |      80 |   68.75 | 33-35,45-46                                                                                                    
  ticketsTreeProvider.ts       |    7.84 |        0 |       0 |    8.16 | 23-158                                                                                                         
-------------------------------|---------|----------|---------|---------|----------------------------------------------------------------------------------------------------------------
Test Suites: 1 passed, 1 total
Tests:       42 passed, 42 total
Snapshots:   0 total
Time:        4.746 s
Ran all test suites matching orchestrator.test.ts.
