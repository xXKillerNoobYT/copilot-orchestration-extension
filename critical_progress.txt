TEST FIXES SUMMARY - February 4, 2026
====================================

ORIGINAL STATE:
- 14 failing tests (97.66% pass rate)
- Files: ticketDb.test.ts (primary issue)

COMPLETED FIXES (6/14):
1. Migration "SQLite table without type column" - FIXED ✓
   Solution: Added jest.resetModules() after jest.doMock(), re-init config
   
2. Migration "read old tickets without type field" - FIXED ✓
   Solution: Same as #1 + resetTicketDbForTests() call
   
3. Error Handling "createTicket error" - FIXED ✓
   Solution: jest.resetModules() after doMock() + reset dbInstance

4. Error Handling "getAllTickets error" - FIXED ✓  
   Solution: jest.resetModules() after doMock() + reset dbInstance
   
5. Error Handling "getTicket error" - FIXED ✓
   Solution: jest.resetModules() after doMock() + reset dbInstance
   
6. Error Handling "warn when initialize twice" - FIXED✓
   Solution: jest.resetModules() after doMock(logger) + doMock(sqlite3)

CURRENT STATE:  
- 594/596 tests passing (99.66% pass rate)
- 2 tests still failing in Integration section:

REMAINING FAILURES (2/14):
1. "should complete full CRUD lifecycle" (Line 791)
   - Expected: retrieved?.id == created.id
   - Got: 'OLD-001' (from migration test)
   - Issue: Data leak from migration tests

2. "should handle concurrent updates" (Line 834)
   - Expected: final?.title == 'Update 2'
   - Got: 'Old Ticket' (from migration test)
   - Issue: Data leak from migration tests

ROOT CAUSE:
- Integration tests' beforeEach uses jest.doMock('sqlite3', throw Error)
- Added jest.resetModules() fix but old test data still persisting
- oldTicketRow from migration "should read old..." test is being returned
- Suggests in-memory store or mock responses not properly isolated

INTEGRATION TESTS beforeEach FIX APPLIED:
- Added jest.resetModules() after jest.doMock
- Added config re-initialization after resetModules
- But data isolation still needed

KEY PATTERNS DISCOVERED:
- jest.doMock() requires jest.resetModules() immediately after
- resetModules() clears config, so must re-initialize with initializeConfig()
- resetTicketDbForTests() must be called immediately after require() to clear dbInstance
- Tests using jest.doMock must have their own isolated beforeEach or test setup

NEXT WORK:
- Fix the 2 Integration test data leakage issues
- Consider adding explicit oldTestData cleanup
- Or ensure mock database doesn't return oldTicketRow for Integration tests
- May need to add resetTicketDbForTests() call to Integration beforeEach
