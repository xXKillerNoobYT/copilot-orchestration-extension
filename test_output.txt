
> copilot-orchestration-extension@0.0.1 test:once
> jest tests/llmService.test.ts

FAIL tests/llmService.test.ts (21.501 s)
  LLM Service
    initializeLLMService
      ΓêÜ should throw error if fetch is not available (Node <18) (27 ms)
      ΓêÜ should use default config if file is missing (1 ms)
      ΓêÜ should read config from file if it exists (1 ms)
      ΓêÜ should validate and use defaults for invalid timeoutSeconds (1 ms)
      ΓêÜ should validate and use defaults for invalid maxTokens (1 ms)
      ΓêÜ should handle JSON parse errors gracefully
    completeLLM
      ΓêÜ should make successful LLM request (3 ms)
      ΓêÜ should include system prompt if provided (1 ms)
      ΓêÜ should handle network errors and create blocked ticket (2 ms)
      ΓêÜ should handle HTTP error responses (1 ms)
      ΓêÜ should handle timeout with AbortError (2 ms)
      ΓêÜ should handle ECONNREFUSED error specifically (1 ms)
    streamLLM
      ΓêÜ should stream chunks and accumulate response (1 ms)
      ΓêÜ should skip malformed SSE lines gracefully (2 ms)
      ├ù should abort on inactivity timeout (5008 ms)
      ΓêÜ should handle streaming network errors (1 ms)
      ΓêÜ should handle HTTP error in streaming
      ├ù should abort on startup timeout (5007 ms)
      ├ù should abort on inactivity timeout after first chunk (5002 ms)
      ├ù should not double-abort if startup and inactivity timeouts overlap (5001 ms)
    token management
      token estimation
        ΓêÜ should estimate tokens for empty string as 0
        ΓêÜ should estimate tokens with reasonable accuracy (1 ms)
        ΓêÜ should estimate longer text with ┬▒20% variance tolerance (1 ms)
      message trimming
        ΓêÜ should not trim messages under 80% of maxTokens (1 ms)
        ΓêÜ should trim oldest messages when over 80% of maxTokens (1 ms)
        ΓêÜ should preserve system message even if it exceeds limit (1 ms)
        ΓêÜ should keep system message + last 3 exchanges minimum
      integration with completeLLM
        ΓêÜ should apply trimming before calling LLM (2 ms)
        ΓêÜ should work with legacy mode (prompt + systemPrompt)
      integration with streamLLM
        ΓêÜ should apply trimming before streaming (1 ms)

  ΓùÅ LLM Service ΓÇ║ streamLLM ΓÇ║ should abort on inactivity timeout

    thrown: "Exceeded timeout of 5000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      329 |         });
      330 |
    > 331 |         it('should abort on inactivity timeout', async () => {
          |         ^
      332 |             // Reinit with short timeout for testing (1.2 seconds, just over the 1s check interval)
      333 |             await reinitWithConfig({
      334 |                 endpoint: 'http://localhost:1234/v1',

      at tests/llmService.test.ts:331:9
      at tests/llmService.test.ts:243:5
      at Object.<anonymous> (tests/llmService.test.ts:35:1)

  ΓùÅ LLM Service ΓÇ║ streamLLM ΓÇ║ should abort on startup timeout

    thrown: "Exceeded timeout of 5000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      395 |         });
      396 |
    > 397 |         it('should abort on startup timeout', async () => {
          |         ^
      398 |             // Reinit with short startup timeout (0.5 seconds = 500ms)
      399 |             await reinitWithConfig({
      400 |                 endpoint: 'http://localhost:1234/v1',

      at tests/llmService.test.ts:397:9
      at tests/llmService.test.ts:243:5
      at Object.<anonymous> (tests/llmService.test.ts:35:1)

  ΓùÅ LLM Service ΓÇ║ streamLLM ΓÇ║ should abort on inactivity timeout after first chunk

    thrown: "Exceeded timeout of 5000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      424 |         }, 5000);  // 5 second timeout for real timeout testing
      425 |
    > 426 |         it('should abort on inactivity timeout after first chunk', async () => {
          |         ^
      427 |             // Reinit with short inactivity timeout (1.2 seconds, just over the 1s check interval)
      428 |             await reinitWithConfig({
      429 |                 endpoint: 'http://localhost:1234/v1',

      at tests/llmService.test.ts:426:9
      at tests/llmService.test.ts:243:5
      at Object.<anonymous> (tests/llmService.test.ts:35:1)

  ΓùÅ LLM Service ΓÇ║ streamLLM ΓÇ║ should not double-abort if startup and inactivity timeouts overlap

    thrown: "Exceeded timeout of 5000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      461 |         }, 5000);  // 5 second timeout for real timeout testing
      462 |
    > 463 |         it('should not double-abort if startup and inactivity timeouts overlap', async () => {
          |         ^
      464 |             // Reinit with overlapping short timeouts
      465 |             await reinitWithConfig({
      466 |                 endpoint: 'http://localhost:1234/v1',

      at tests/llmService.test.ts:463:9
      at tests/llmService.test.ts:243:5
      at Object.<anonymous> (tests/llmService.test.ts:35:1)

Test Suites: 1 failed, 1 total
Tests:       4 failed, 26 passed, 30 total
Snapshots:   0 total
Time:        21.82 s, estimated 23 s
Ran all test suites matching tests/llmService.test.ts.
